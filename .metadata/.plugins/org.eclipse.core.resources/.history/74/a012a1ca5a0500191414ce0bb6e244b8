<?xml version="1.0" encoding="UTF-8"?>

<mule xmlns:email="http://www.mulesoft.org/schema/mule/email" xmlns:file="http://www.mulesoft.org/schema/mule/file"
	xmlns:db="http://www.mulesoft.org/schema/mule/db"
	xmlns:ee="http://www.mulesoft.org/schema/mule/ee/core" xmlns:amqp="http://www.mulesoft.org/schema/mule/amqp" xmlns="http://www.mulesoft.org/schema/mule/core" xmlns:doc="http://www.mulesoft.org/schema/mule/documentation" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd
http://www.mulesoft.org/schema/mule/amqp http://www.mulesoft.org/schema/mule/amqp/current/mule-amqp.xsd
http://www.mulesoft.org/schema/mule/ee/core http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd
http://www.mulesoft.org/schema/mule/db http://www.mulesoft.org/schema/mule/db/current/mule-db.xsd
http://www.mulesoft.org/schema/mule/file http://www.mulesoft.org/schema/mule/file/current/mule-file.xsd
http://www.mulesoft.org/schema/mule/email http://www.mulesoft.org/schema/mule/email/current/mule-email.xsd">
	<flow name="capella-event-consume-trainingFlow" doc:id="23b91216-a5e8-40f2-9141-53b8d5e21b91">
		<amqp:listener doc:name="Listener" doc:id="8373dd71-6639-486f-8dcc-46ac15038bb4" config-ref="AMQP_Config_RabbitMQ" queueName="Science Fair 2019" />
		<set-variable value="#[payload]" doc:name="Save payload " doc:id="0f95dba8-10b9-414b-86e8-06b4dc55d688" variableName="var_payload" />
		<scatter-gather doc:name="Scatter-Gather" doc:id="f4f67f78-4cfe-49be-8532-08ab3af28bf3">
			<route>
				<flow-ref doc:name="CSV -Email Attachment" doc:id="4696f4c8-24c2-4171-952e-68b4b330d376" name="csv-emailattachment-flow" />
			</route>
			<route>
				<flow-ref doc:name="Insert payload to DB" doc:id="9e4e3c81-6837-4eba-bd27-cba63928e722" name="db-insert-flow" />
			</route>
			<route>
				<flow-ref doc:name="xml- Upload FTP" doc:id="49a36e1d-43fa-42f0-9fde-78fe93b00174" name="xml-upload-ftp-flow" />
			</route>
			<route>
				<flow-ref doc:name="Flow Reference" doc:id="97644b8d-2500-4519-91d9-841fbb85ce26" name="insert-salesforce-flow" />
			</route>
		</scatter-gather>
	</flow>
	<flow name="insert-salesforce-flow" doc:id="b51a3ddd-818e-4fbe-810a-9bac0d14a5f9" >
		<logger level="INFO" doc:name="Logger" doc:id="0c0dfc7b-68f8-4984-a226-8dd2ac24c716" />
	</flow>
	<flow name="xml-upload-ftp-flow" doc:id="64d2ea65-3532-4ded-abf5-fb61af61f88b" >
		<ee:transform doc:name="Transform Message to xml" doc:id="8881228e-91a0-4c7e-af48-2aee2b55dd1f" >
			<ee:message />
			<ee:variables >
				<ee:set-variable variableName="var_customer_xml" ><![CDATA[%dw 2.0
output application/xml
---
customers: {(vars.var_payload.customers map (object,index) -> {
    'customer': object
    }
)}
]]></ee:set-variable>
			</ee:variables>
		</ee:transform>
		<file:write doc:id="57e21067-acb7-49f1-8232-d49ec133b9c6" path="C:\test\output\123.xml" doc:name="Write-To-xml" >
			<file:content ><![CDATA[#[vars.var_customer_xml]]]></file:content>
		</file:write>
		<logger level="INFO" doc:name="Logger" doc:id="ca0f8080-5ec8-4770-b423-82fe67fd7d7e" />
	</flow>
	<flow name="db-insert-flow" doc:id="7d787f53-99eb-4bf6-83c1-d49632df6e28" >
		<ee:transform doc:name="Transform Message" doc:id="ed50569d-6dd5-4fff-9200-a4b087af4660" >
			<ee:message >
			</ee:message>
			<ee:variables >
				<ee:set-variable variableName="var_payload_json_string" ><![CDATA[%dw 2.0
output application/java
---
write(vars.var_payload, "application/json")]]></ee:set-variable>
			</ee:variables>
		</ee:transform>
		<db:insert doc:id="67dce04e-e6ac-4aca-aa11-6ff0598981be" config-ref="mssql_Database_Config" doc:name="INSERT Record into DB">
			<db:sql>INSERT INTO [dbo].[ConsumeMessage]
           (message, queue)
     VALUES  (:message, :queue)</db:sql>
			<db:input-parameters ><![CDATA[#[output application/java
 ---
 {
     'message' : vars.var_payload_json_string,
     'queue' : 'Science Fair 2019'
 }]]]></db:input-parameters>
		</db:insert>
		<logger level="INFO" doc:name="Logger" doc:id="6f8b1e3b-55d8-4f7a-927a-4ed99fee7396" />
	</flow>
	<flow name="csv-emailattachment-flow" doc:id="83bddce2-e658-4f06-b61c-89966911429a" >
		<ee:transform doc:name="Transform Message to CSV" doc:id="2e02f5c8-96ef-427d-bae8-5c2940262afd" >
			<ee:message />
			<ee:variables >
				<ee:set-variable variableName="var_customer_csv" ><![CDATA[%dw 2.0
output application/csv header=true
---
vars.var_payload.payload.customers
]]></ee:set-variable>
			</ee:variables>
		</ee:transform>
		<email:send doc:name="Send" doc:id="5632e22e-011c-4398-927c-e76bdd30c324" config-ref="Email_SMTP_gmail" fromAddress="dev.concordusa#gmail.com" subject="Testing email Mule 4">
			<email:to-addresses >
				<email:to-address value="sant.rijal@gmail.com" />
			</email:to-addresses>
			<email:body contentTransferEncoding="7BIT">
				<email:content ><![CDATA[#['This is a test']]]></email:content>
			</email:body>
		</email:send>
		<logger level="INFO" doc:name="Logger" doc:id="22a458a5-6758-4b18-85b0-62b769f79c0d" />
	</flow>
</mule>
